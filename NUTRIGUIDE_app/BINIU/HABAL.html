<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FortichRide — Habal-Habal Reservation System (Prototype)</title>

  <!-- External libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{--accent:#0ea5a3;--bg:#071029;--card:#071a2b;--muted:#94a3b8}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#e6f7f5 0%, #f8fafc 100%);color:#042022}
    .app-wrap{max-width:1200px;margin:18px auto;padding:14px}
    header.app-header{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#065f73,#38b2ac);display:flex;align-items:center;justify-content:center;color:#021427;font-weight:700}
    .app-title{line-height:1}
    .app-title h1{margin:0;font-size:1.25rem}
    .app-title p{margin:0;font-size:0.9rem;color:var(--muted)}

    .main-grid{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:14px}
    .card{border-radius:12px;padding:12px;background:#ffffff;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    label{font-size:13px;color:#374151}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef0}
    button.btn{transition:transform .12s ease,box-shadow .12s ease}
    button.btn:hover{transform:translateY(-3px)}

    #map{height:460px;border-radius:10px;border:1px solid #e6eef0}
    .small-muted{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .badge-status{padding:6px 8px;border-radius:999px;font-weight:600}

    table th, table td{vertical-align:middle;font-size:13px}
    .driver-dot{width:14px;height:14px;border-radius:50%}

    .hover-glow{transition:box-shadow .15s ease;}
    .hover-glow:hover{box-shadow:0 10px 30px rgba(14,165,163,0.12)}

    .footer-note{font-size:13px;color:#475569;margin-top:12px}

    @media(max-width:980px){.main-grid{grid-template-columns:1fr;}.card{padding:10px}}
  </style>
</head>
<body>
  <div class="app-wrap">
    <header class="app-header">
      <div class="logo">FR</div>
      <div class="app-title">
        <h1>FortichRide — Habal-Habal Reservation System</h1>
        <p class="small-muted">A community-focused booking prototype for Manolo Fortich — estimates fares, simulates drivers on a map, and provides role-based dashboards.</p>
        <div class="small-muted">Developed by <strong>John Tristan Suan</strong> — Manolo Fortich National High School (ICT Project)</div>
      </div>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm"><i class="fa-regular fa-moon"></i></button>
        <button id="exportBtn" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-download"></i> Export CSV</button>
      </div>
    </header>

    <div class="main-grid">
      <!-- LEFT COLUMN -->
      <div>
        <div class="card hover-glow" id="authCard">
          <div class="d-flex align-items-center justify-content-between">
            <strong>Sign in / Role</strong>
            <span class="small-muted">Session stored locally (browser)</span>
          </div>
          <div style="margin-top:10px">
            <label>Role</label>
            <select id="roleSelect" class="mb-2"><option value="passenger">Passenger</option><option value="driver">Driver</option><option value="admin">Admin</option></select>
            <label>Name</label>
            <input id="nameInput" placeholder="Juan Dela Cruz" />
            <label id="idLabel">Phone / Plate</label>
            <input id="idInput" placeholder="0917xxxxxxx or PLT-001" />
            <div class="d-flex gap-2 mt-2">
              <button id="signInBtn" class="btn btn-success">Sign In</button>
              <button id="signOutBtn" class="btn btn-outline-danger">Sign Out</button>
            </div>
            <div class="small-muted mt-2">Signed-in users see role-specific screens: Passenger (book rides), Driver (accept rides), Admin (manage & export).</div>
          </div>
        </div>

        <div class="card hover-glow mt-3" id="passengerCard">
          <strong>Passenger — Book a ride</strong>
          <div class="small-muted">Estimate fares & request pickup. Click map to set pickup/drop points.</div>
          <div style="margin-top:8px">
            <label>Pickup (barangay or coords)</label>
            <input id="pickupInput" placeholder="e.g., Poblacion or '8.280,124.900'" />
            <label>Drop-off</label>
            <input id="dropInput" placeholder="e.g., Malaybalay or '8.300,125.000'" />
            <div class="d-flex gap-2 mt-2">
              <button id="estimateBtn" class="btn btn-info">Estimate Fare</button>
              <button id="bookBtn" class="btn btn-primary">Request Ride</button>
            </div>
            <div class="mt-2">
              <input id="fareField" disabled placeholder="Fare & ETA will appear here" />
            </div>
          </div>
        </div>

        <div class="card hover-glow mt-3 d-none" id="driverCard">
          <strong>Driver — Console</strong>
          <div class="small-muted">Go online to receive requests. Accept or reject manually, or let auto-assign handle requests.</div>
          <div style="margin-top:8px">
            <div class="d-flex gap-2">
              <button id="goOnlineBtn" class="btn btn-success">Go Online</button>
              <button id="goOfflineBtn" class="btn btn-outline-secondary">Go Offline</button>
            </div>
            <div class="mt-2">Earnings: <span id="earningBadge" class="badge bg-light text-dark">₱0.00</span></div>
            <div class="mt-2"><strong>Incoming Requests</strong></div>
            <table class="table table-sm mt-2">
              <thead><tr><th>Passenger</th><th>Fare</th><th>Action</th></tr></thead>
              <tbody id="incomingTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card hover-glow mt-3" id="adminCard">
          <strong>Admin Panel</strong>
          <div class="small-muted">Manage drivers and bookings. Export data for reports.</div>
          <div class="mt-2 d-flex gap-2">
            <button id="addSampleDriversBtn" class="btn btn-outline-primary btn-sm">Add Sample Drivers</button>
            <button id="purgeDriversBtn" class="btn btn-outline-danger btn-sm">Purge Drivers</button>
            <button id="purgeBookingsBtn" class="btn btn-outline-danger btn-sm">Purge Bookings</button>
          </div>
          <div class="mt-2">
            <strong>Drivers</strong>
            <table class="table table-sm mt-2"><thead><tr><th>Name</th><th>Contact/Plate</th><th>Status</th><th>Earnings</th></tr></thead><tbody id="driversTbody"></tbody></table>
          </div>
          <div class="mt-2">
            <strong>All Bookings</strong>
            <div style="max-height:180px;overflow:auto;"> <table class="table table-sm"><thead><tr><th>Passenger</th><th>From → To</th><th>Fare</th><th>Status</th></tr></thead><tbody id="bookingsTbody"></tbody></table></div>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Live Map — Drivers & Bookings</strong>
            <div class="small-muted">Click map to set pickup/drop. Use "Center to me" to simulate user location.</div>
          </div>
          <div id="map" class="mt-2"></div>
          <div class="d-flex gap-2 mt-2">
            <button id="centerBtn" class="btn btn-outline-secondary btn-sm">Center to MF</button>
            <button id="showDriversBtn" class="btn btn-outline-primary btn-sm">Show Drivers</button>
            <button id="showBookingsBtn" class="btn btn-outline-info btn-sm">Show Active Bookings</button>
          </div>
        </div>

        <div class="card mt-3">
          <strong>About / Instructions</strong>
          <p class="small-muted">This single-file prototype simulates a habal-habal booking flow: passengers estimate fares and request rides, drivers accept requests, and admins can oversee operations. It uses browser localStorage as a mock backend. For deployment, swap localStorage with Firebase or a backend API.</p>
          <div class="footer-note">Tip: add sample drivers (Admin) then sign in as Passenger and request a ride — drivers will auto-accept in demo mode.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirm Ride</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="confirmOk" type="button" class="btn btn-primary">Confirm</button></div></div></div></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // === Storage keys ===
    const K_DRIVERS = 'fr_drivers';
    const K_BOOKINGS = 'fr_bookings';
    const K_SESSION = 'fr_session';

    // === Helpers ===
    const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const load = (k,def)=>{try{const v=JSON.parse(localStorage.getItem(k));return v||def}catch(e){return def}};
    const uid = (p='id')=>p+Math.random().toString(36).slice(2,9);
    const now = ()=>new Date().toISOString();

    // Initialize storage
    if(!localStorage.getItem(K_DRIVERS)) save(K_DRIVERS,[]);
    if(!localStorage.getItem(K_BOOKINGS)) save(K_BOOKINGS,[]);

    // UI elements
    const roleSelect = document.getElementById('roleSelect');
    const nameInput = document.getElementById('nameInput');
    const idInput = document.getElementById('idInput');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');

    const passengerCard = document.getElementById('passengerCard');
    const driverCard = document.getElementById('driverCard');
    const adminCard = document.getElementById('adminCard');

    const pickupInput = document.getElementById('pickupInput');
    const dropInput = document.getElementById('dropInput');
    const estimateBtn = document.getElementById('estimateBtn');
    const bookBtn = document.getElementById('bookBtn');
    const fareField = document.getElementById('fareField');

    const goOnlineBtn = document.getElementById('goOnlineBtn');
    const goOfflineBtn = document.getElementById('goOfflineBtn');
    const incomingTbody = document.getElementById('incomingTbody');
    const earningBadge = document.getElementById('earningBadge');

    const addSampleDriversBtn = document.getElementById('addSampleDriversBtn');
    const purgeDriversBtn = document.getElementById('purgeDriversBtn');
    const purgeBookingsBtn = document.getElementById('purgeBookingsBtn');
    const driversTbody = document.getElementById('driversTbody');
    const bookingsTbody = document.getElementById('bookingsTbody');

    const exportBtn = document.getElementById('exportBtn');
    const centerBtn = document.getElementById('centerBtn');
    const showDriversBtn = document.getElementById('showDriversBtn');
    const showBookingsBtn = document.getElementById('showBookingsBtn');

    // confirm modal
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const confirmBody = document.getElementById('confirmBody');
    const confirmOk = document.getElementById('confirmOk');

    // Map
    const map = L.map('map', {zoomControl:true}).setView([8.285,124.8996], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    let pickupMarker=null, dropMarker=null;
    const driverMarkers = {};
    const bookingMarkers = {};

    map.on('click', function(e){
      // if pickup input focused -> set pickup, else set drop
      const active = document.activeElement;
      if(active === pickupInput){ setPickup(e.latlng); pickupInput.value = e.latlng.lat.toFixed(6)+','+e.latlng.lng.toFixed(6); }
      else if(active === dropInput){ setDrop(e.latlng); dropInput.value = e.latlng.lat.toFixed(6)+','+e.latlng.lng.toFixed(6); }
      else if(!pickupMarker){ setPickup(e.latlng); pickupInput.value = e.latlng.lat.toFixed(6)+','+e.latlng.lng.toFixed(6); }
      else { setDrop(e.latlng); dropInput.value = e.latlng.lat.toFixed(6)+','+e.latlng.lng.toFixed(6); }
    });

    function setPickup(latlng){ if(pickupMarker) map.removeLayer(pickupMarker); pickupMarker = L.marker(latlng,{icon:defaultIcon('green')}).addTo(map).bindPopup('Pickup') }
    function setDrop(latlng){ if(dropMarker) map.removeLayer(dropMarker); dropMarker = L.marker(latlng,{icon:defaultIcon('red')}).addTo(map).bindPopup('Drop-off') }

    function defaultIcon(color){
      return L.divIcon({className:'',html:`<div style="width:14px;height:14px;border-radius:4px;background:${color};border:2px solid #fff"></div>`,iconSize:[18,18]})
    }

    // parse location helper
    function parseLocation(val){
      if(!val) return null;
      const m = val.match(/(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
      if(m) return {lat:parseFloat(m[1]),lng:parseFloat(m[2])};
      // fake geocode: map name to near center
      const base = {lat:8.285,lng:124.8996};
      let h=0; for(let i=0;i<val.length;i++){h=(h<<5)-h+val.charCodeAt(i); h|=0}
      const offset = ((h % 1000)/10000);
      return {lat: base.lat + offset, lng: base.lng + offset};
    }

    // haversine
    function haversine(a,b){
      const R=6371; const toRad = x=>x*Math.PI/180;
      const dLat = toRad(b.lat-a.lat); const dLon = toRad(b.lng-a.lng);
      const la = toRad(a.lat); const lb = toRad(b.lat);
      const s = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2*Math.cos(la)*Math.cos(lb);
      return 2*R*Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
    }

    // fare estimator
    function estimateFare(fromStr,toStr,passengers=1){
      const a = parseLocation(fromStr), b = parseLocation(toStr);
      const km = Math.max(0.5, haversine(a,b));
      const base = 10; const perKm = 9; const paxAdd = 5*(passengers-1);
      const fare = Math.round((base + perKm*km + paxAdd)*100)/100;
      const etaMin = Math.max(4, Math.round((km/25)*60)); // assume avg 25 km/h
      return {fare,km:Math.round(km*100)/100,eta:etaMin};
    }

    // Session handling
    let session = load(K_SESSION, null);
    function setSession(s){ session=s; save(K_SESSION,s); renderRoleUI(); }
    function clearSession(){ session=null; localStorage.removeItem(K_SESSION); renderRoleUI(); }

    signInBtn.addEventListener('click', ()=>{
      const role = roleSelect.value; const name = (nameInput.value||'').trim() || (role==='driver'?'Driver'+Math.floor(Math.random()*90):'Passenger'+Math.floor(Math.random()*90));
      const ident = (idInput.value||'').trim() || (role==='driver'?'PL-'+Math.random().toString(36).slice(2,6):'P-'+Math.random().toString(36).slice(2,6));
      const s = {role,name,identifier:ident,online:false}; setSession(s); alert('Signed in as '+role.toUpperCase()+': '+name);
      // ensure driver record exists
      if(role==='driver'){ const ds = load(K_DRIVERS,[]); if(!ds.find(x=>x.identifier===ident)){ ds.push({id:uid('drv_'),name,identifier:ident,online:false,earnings:0,location:{lat:8.285+Math.random()*0.03,lng:124.9+Math.random()*0.03}}); save(K_DRIVERS,ds); renderDriversTable(); renderMapDrivers() } }
    });
    signOutBtn.addEventListener('click', ()=>{ clearSession(); alert('Signed out'); });

    function renderRoleUI(){
      const s = session;
      passengerCard.style.display = (!s || s.role==='passenger') ? 'block' : 'none';
      driverCard.style.display = (s && s.role==='driver') ? 'block' : 'none';
      adminCard.style.display = (s && s.role==='admin') ? 'block' : 'none';
      // prefill inputs
      if(s){ nameInput.value=s.name; idInput.value=s.identifier }
      renderDriversTable(); renderBookingsTable(); renderDriverIncoming(); renderMapDrivers(); renderMapBookings(); updateEarnings();
    }

    // Booking flow
    function createBooking(passName,passIdent,from,to,pax=1,notes=''){
      const est = estimateFare(from,to,pax);
      const bookings = load(K_BOOKINGS,[]);
      const b = {id:uid('bk_'), passengerName:passName, passengerIdent:passIdent, from,to, pax, fare:est.fare, km:est.km, eta:est.eta, status:'pending', createdAt:now()};
      bookings.push(b); save(K_BOOKINGS,bookings); renderBookingsTable(); renderDriverIncoming(); renderMapBookings(); return b;
    }

    estimateBtn.addEventListener('click', ()=>{
      const from = pickupInput.value.trim(); const to = dropInput.value.trim(); if(!from||!to) return alert('Enter pickup & drop');
      const est = estimateFare(from,to,1); fareField.value = `₱${est.fare} — ${est.km} km — ETA ${est.eta} min`;
    });

    bookBtn.addEventListener('click', ()=>{
      if(!session || session.role!=='passenger') return alert('Sign in as Passenger to request ride');
      const from = pickupInput.value.trim(); const to = dropInput.value.trim(); if(!from||!to) return alert('Enter pickup & drop');
      const est = estimateFare(from,to,1);
      confirmBody.innerHTML = `<p>Request ride from <strong>${escapeHtml(from)}</strong> to <strong>${escapeHtml(to)}</strong>.<br>Fare: <strong>₱${est.fare}</strong> — ETA: <strong>${est.eta} min</strong></p>`;
      confirmOk.onclick = ()=>{ createBooking(session.name, session.identifier, from, to); confirmModal.hide(); alert('Ride requested — waiting for driver'); }
      confirmModal.show();
    });

    // Driver actions
    goOnlineBtn.addEventListener('click', ()=>{ if(!session || session.role!=='driver') return alert('Sign in as Driver');
      session.online=true; setSession(session); const drivers = load(K_DRIVERS,[]); const d = drivers.find(x=>x.identifier===session.identifier); if(d) d.online=true; save(K_DRIVERS,drivers); renderDriversTable(); renderMapDrivers(); renderDriverIncoming(); updateEarnings();
    });
    goOfflineBtn.addEventListener('click', ()=>{ if(!session || session.role!=='driver') return alert('Sign in as Driver'); session.online=false; setSession(session); const drivers = load(K_DRIVERS,[]); const d = drivers.find(x=>x.identifier===session.identifier); if(d) d.online=false; save(K_DRIVERS,drivers); renderDriversTable(); renderMapDrivers(); renderDriverIncoming(); updateEarnings(); });

    function driverAccept(bookingId){ if(!session || session.role!=='driver') return alert('Sign in as Driver');
      const bookings = load(K_BOOKINGS,[]); const b = bookings.find(x=>x.id===bookingId); if(!b) return alert('Booking not found'); if(b.status!=='pending') return alert('Booking already processed');
      b.status='accepted'; b.driver = session.identifier; b.acceptedAt = now(); save(K_BOOKINGS,bookings);
      // credit driver earnings (85% share)
      const drivers = load(K_DRIVERS,[]); const d = drivers.find(x=>x.identifier===session.identifier); if(d){ d.earnings=(d.earnings||0)+(b.fare*0.85); save(K_DRIVERS,drivers); }
      renderDriverIncoming(); renderBookingsTable(); renderDriversTable(); renderMapBookings(); updateEarnings(); alert('Accepted booking');
    }
    function driverReject(bookingId){ const bookings = load(K_BOOKINGS,[]); const b = bookings.find(x=>x.id===bookingId); if(!b) return; b.status='rejected'; b.rejectedAt=now(); save(K_BOOKINGS,bookings); renderDriverIncoming(); renderBookingsTable(); renderMapBookings(); }

    // Render incoming table for drivers
    function renderDriverIncoming(){ const tbody = incomingTbody; tbody.innerHTML=''; const bookings = load(K_BOOKINGS,[]).filter(x=>x.status==='pending'); bookings.forEach(b=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(b.passengerName)}</td><td>₱${b.fare}</td><td><button class="btn btn-sm btn-success me-1" onclick="driverAccept('${b.id}')">Accept</button><button class="btn btn-sm btn-outline-danger" onclick="driverReject('${b.id}')">Reject</button></td>`; tbody.appendChild(tr); }); }
    window.driverAccept = driverAccept; window.driverReject = driverReject;

    // Admin features
    addSampleDriversBtn.addEventListener('click', ()=>{
      const drivers = load(K_DRIVERS,[]);
      const samples = [ {id:uid('drv_'),name:'Jun P.',identifier:'09171230001',online:true,earnings:120,location:{lat:8.285+Math.random()*0.02,lng:124.9+Math.random()*0.02}}, {id:uid('drv_'),name:'Lito R.',identifier:'09171230002',online:false,earnings:86,location:{lat:8.27+Math.random()*0.02,lng:124.88+Math.random()*0.02}}, {id:uid('drv_'),name:'Ariel S.',identifier:'PLT-528',online:true,earnings:240,location:{lat:8.295+Math.random()*0.02,lng:124.91+Math.random()*0.02}} ];
      save(K_DRIVERS,drivers.concat(samples)); renderDriversTable(); renderMapDrivers();
    });
    purgeDriversBtn.addEventListener('click', ()=>{ if(confirm('Purge all drivers?')){ save(K_DRIVERS,[]); renderDriversTable(); renderMapDrivers(); } });
    purgeBookingsBtn.addEventListener('click', ()=>{ if(confirm('Purge all bookings?')){ save(K_BOOKINGS,[]); renderBookingsTable(); renderDriverIncoming(); renderMapBookings(); } });

    function renderDriversTable(){ const tbody = driversTbody; const drivers = load(K_DRIVERS,[]); tbody.innerHTML=''; drivers.forEach(d=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.identifier)}</td><td>${d.online?'<span class="badge bg-success">Online</span>':'<span class="badge bg-secondary">Offline</span>'}</td><td>₱${(d.earnings||0).toFixed(2)}</td>`; tbody.appendChild(tr); }); }

    function renderBookingsTable(){ const tbody = bookingsTbody; const bookings = load(K_BOOKINGS,[]); tbody.innerHTML=''; bookings.forEach(b=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(b.passengerName)}</td><td>${escapeHtml(b.from)} → ${escapeHtml(b.to)}</td><td>₱${b.fare}</td><td>${escapeHtml(b.status)}</td>`; tbody.appendChild(tr); }); }

    // Map rendering for drivers
    function renderMapDrivers(){ const drivers = load(K_DRIVERS,[]); // clear old
      for(const id in driverMarkers){ try{ map.removeLayer(driverMarkers[id]) }catch(e){} delete driverMarkers[id]; }
      drivers.forEach(d=>{ if(!d.location) d.location={lat:8.285+Math.random()*0.03,lng:124.9+Math.random()*0.03}; const m = L.marker([d.location.lat,d.location.lng],{title:d.name,icon:L.divIcon({className:'',html:`<div style="background:${d.online?'#16a34a':'#6b7280'};width:14px;height:14px;border-radius:50%;border:2px solid #fff"></div>`})}).addTo(map).bindPopup(`<strong>${escapeHtml(d.name)}</strong><br>${escapeHtml(d.identifier)}<br>${d.online?'<em>Online</em>':'<em>Offline</em>'}`); driverMarkers[d.id]=m; }); }

    // Render bookings on map
    function renderMapBookings(){ const bookings = load(K_BOOKINGS,[]); // clear
      for(const id in bookingMarkers){ const arr = bookingMarkers[id]; arr.forEach(x=>{ try{ map.removeLayer(x) }catch(e){} }); delete bookingMarkers[id]; }
      bookings.filter(b=>b.status!=='completed' && b.status!=='rejected').forEach(b=>{ const a=parseLocation(b.from); const c=parseLocation(b.to); const m1=L.circleMarker([a.lat,a.lng],{radius:6}).addTo(map).bindPopup(`${escapeHtml(b.passengerName)} (₱${b.fare}) - ${b.status}`); const m2=L.circleMarker([c.lat,c.lng],{radius:6,color:'#ff6b6b'}).addTo(map); bookingMarkers[b.id]=[m1,m2]; }); }

    // Auto-assign simulator: every 12s assign oldest pending booking to an online driver
    setInterval(()=>{
      const bookings = load(K_BOOKINGS,[]).filter(b=>b.status==='pending'); if(bookings.length===0) return; const drivers = load(K_DRIVERS,[]).filter(d=>d.online);
      if(drivers.length===0) return;
      const b = bookings[0]; const d = drivers[Math.floor(Math.random()*drivers.length)]; b.status='accepted'; b.driver = d.identifier; b.acceptedAt = now(); save(K_BOOKINGS, load(K_BOOKINGS).map(x=>x.id===b.id?b:x)); // credit
      const all = load(K_DRIVERS,[]); const dd = all.find(x=>x.identifier===d.identifier); if(dd){ dd.earnings=(dd.earnings||0)+(b.fare*0.85); save(K_DRIVERS,all); }
      renderBookingsTable(); renderDriverIncoming(); renderDriversTable(); renderMapBookings(); renderMapDrivers(); updateEarnings();
    }, 12000);

    // Auto-complete simulator: accepted -> completed after 20s
    setInterval(()=>{
      let changed=false; const bookings = load(K_BOOKINGS,[]); bookings.forEach(b=>{ if(b.status==='accepted' && b.acceptedAt && !b.completedAt){ if((Date.now() - new Date(b.acceptedAt).getTime())>20000){ b.status='completed'; b.completedAt=now(); changed=true } } }); if(changed){ save(K_BOOKINGS,bookings); renderBookingsTable(); renderMapBookings(); }
    }, 8000);

    // Export CSV
    exportBtn.addEventListener('click', ()=>{
      const bookings = load(K_BOOKINGS,[]); if(bookings.length===0) return alert('No bookings to export');
      const csv = ['id,passenger,from,to,fare,km,status,createdAt'].concat(bookings.map(b=>`${b.id},"${b.passengerName}","${b.from}","${b.to}",${b.fare},${b.km},${b.status},${b.createdAt}`)).join('\n'); const url='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); const a=document.createElement('a'); a.href=url; a.download='fortich_bookings.csv'; a.click();
    });

    // Utilities
    function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function updateEarnings(){ if(session && session.role==='driver'){ const drivers = load(K_DRIVERS,[]); const d = drivers.find(x=>x.identifier===session.identifier); earningBadge.textContent = '₱'+((d&&d.earnings)?(d.earnings).toFixed(2):'0.00'); } else earningBadge.textContent='₱0.00'; }

    function renderBookingsTable(){ renderBookingsTable; } // placeholder to avoid lint side-effect

    // Wire rendering calls
    function renderDriversTable(){ renderDriversTable; }

    // Actually call proper render functions now
    renderDriversTable = function(){ const tbody = driversTbody; const drivers = load(K_DRIVERS,[]); tbody.innerHTML=''; drivers.forEach(d=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.identifier)}</td><td>${d.online?'<span class="badge bg-success">Online</span>':'<span class="badge bg-secondary">Offline</span>'}</td><td>₱${(d.earnings||0).toFixed(2)}</td>`; tbody.appendChild(tr); }); };
    renderBookingsTable = function(){ const tbody = bookingsTbody; const bookings = load(K_BOOKINGS,[]); tbody.innerHTML=''; bookings.forEach(b=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(b.passengerName)}</td><td>${escapeHtml(b.from)} → ${escapeHtml(b.to)}</td><td>₱${b.fare}</td><td>${escapeHtml(b.status)}</td>`; tbody.appendChild(tr); }); };

    // Initial map & render
    renderMapDrivers(); renderMapBookings(); renderDriversTable(); renderBookingsTable(); renderDriverIncoming(); updateEarnings();

    // Buttons
    centerBtn.addEventListener('click', ()=>{ map.setView([8.285,124.8996],12); });
    showDriversBtn.addEventListener('click', ()=>{ renderMapDrivers(); const bounds = Object.values(driverMarkers).map(m=>m.getLatLng()); if(bounds.length) map.fitBounds(bounds); });
    showBookingsBtn.addEventListener('click', ()=>{ renderMapBookings(); const pts = Object.values(bookingMarkers).flat().map(m=>m.getLatLng()); if(pts.length) map.fitBounds(pts); });

    // Theme toggle (simple)
    document.getElementById('themeToggle').addEventListener('click', ()=>{ document.body.classList.toggle('dark'); const icon = document.querySelector('#themeToggle i'); icon.classList.toggle('fa-moon'); icon.classList.toggle('fa-sun'); if(document.body.classList.contains('dark')){ document.body.style.background='linear-gradient(180deg,#071028 0%, #071a2b 60%)'; document.body.style.color='#e6f7f5'; } else { document.body.style.background='linear-gradient(180deg,#e6f7f5 0%, #f8fafc 100%)'; document.body.style.color='#042022'; } });

    // Attach window functions used in HTML events
    window.createBooking = createBooking;
    window.renderMapDrivers = renderMapDrivers;
    window.renderMapBookings = renderMapBookings;

    // Make certain functions globally available for inline use
    window.estimateFare = estimateFare;

    // Ensure passenger UI visible on load
    renderRoleUI();

  </script>
</body>
</html>